import { createClient } from '@supabase/supabase-js';
import { config } from 'dotenv';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

// 현재 파일의 디렉토리 경로를 구하기
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// 환경 변수 로드 (.env.local 파일 사용)
config({ path: join(__dirname, '..', '.env.local') });

// Supabase 클라이언트 생성 (환경 변수 사용)
const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

const DEMO_CLASS_ID = '62af0001-6d16-4001-86e5-e39531ec35f7';

// 샘플 분석 결과 데이터
const sampleOverviewAnalysis = {
  class_id: DEMO_CLASS_ID,
  result_data: JSON.stringify({
    "analysis": "# 3학년 1반 학급 관계 종합 분석\n\n## 🎯 분석 개요\n\n이번 분석은 3학년 1반 40명의 학생들을 대상으로 한 종합적인 학급 관계 분석입니다. 9개의 다양한 설문을 통해 수집된 1,726개의 응답과 14,040개의 관계 데이터를 바탕으로 학급 내 사회적 역학 구조를 파악했습니다.\n\n## 🏫 학급 전체 특성\n\n### 긍정적인 측면\n- **높은 참여도**: 전체 학생의 95% 이상이 설문에 적극적으로 참여\n- **다양한 관계 형성**: 학생들이 폭넓은 또래 관계를 형성하고 있음\n- **균형잡힌 성별 구성**: 남녀 학생 간 자연스러운 교류가 활발\n\n### 주목할 점\n- **리더십 분산**: 여러 학생이 다양한 영역에서 리더십을 발휘\n- **포용적 분위기**: 대부분의 학생이 학급 공동체에 소속감을 느끼고 있음\n- **갈등 관리**: 소규모 갈등이 있지만 건설적으로 해결되는 경향\n\n## 📊 관계 패턴 분석\n\n### 핵심 관계망\n1. **학습 중심 그룹**: 김민준, 이서윤, 박도현을 중심으로 한 학습 동기가 높은 그룹\n2. **사교적 그룹**: 최하은, 정우진, 강시우를 중심으로 한 활발한 소통 그룹\n3. **예술/창의 그룹**: 윤서아, 임재민을 중심으로 한 창의적 활동 선호 그룹\n\n### 특별한 관찰사항\n- **멘토-멘티 관계**: 상급생 역할을 하는 학생들이 자연스럽게 동급생들을 도움\n- **크로스 그룹 연결**: 여러 그룹을 연결하는 '브릿지' 역할 학생들 존재\n- **포용적 태도**: 새로운 학생이나 다른 성향의 학생들을 받아들이는 개방적 분위기\n\n## 🎯 교육적 시사점\n\n### 강점 활용 방안\n1. **협력 학습 활성화**: 기존 관계망을 활용한 모둠 구성\n2. **리더십 개발**: 다양한 영역의 리더들에게 더 많은 기회 제공\n3. **또래 교육**: 학생 간 교육 효과가 높은 영역에서 또래 튜터링 도입\n\n### 개선 필요 영역\n1. **소외 학생 지원**: 관계망에서 상대적으로 소외된 학생들을 위한 특별 관심\n2. **갈등 중재**: 작은 갈등들이 확대되지 않도록 조기 개입 시스템 구축\n3. **다양성 존중**: 서로 다른 성향과 관심사를 가진 학생들 간의 이해 증진\n\n## 💡 구체적 권장사항\n\n### 단기 개선 방안 (1개월 내)\n- 모둠 활동 시 관계망을 고려한 전략적 배치\n- 매주 '친구 칭찬하기' 시간을 통한 긍정적 관계 강화\n- 갈등 상황 발생 시 즉시 대화를 통한 해결 시도\n\n### 중기 개선 방안 (3개월 내)\n- 학급 내 다양한 역할 분담을 통한 책임감 증진\n- 또래 멘토링 시스템 도입으로 학습 효과 및 관계 개선\n- 정기적인 학급 회의를 통한 민주적 의사결정 경험\n\n### 장기 개선 방안 (학기 단위)\n- 학급 전체의 소속감 강화를 위한 공동 프로젝트 수행\n- 개별 학생의 특성을 고려한 맞춤형 지도 방안 수립\n- 학부모와의 연계를 통한 가정-학교 협력 체계 구축\n\n## 🎊 결론\n\n3학년 1반은 전반적으로 건강하고 활력 넘치는 학급 공동체를 형성하고 있습니다. 학생들 간의 자연스러운 유대감과 서로를 존중하는 분위기가 이 학급의 가장 큰 강점입니다. 향후 이러한 긍정적 분위기를 더욱 발전시키면서, 개별 학생들의 다양한 특성을 더욱 존중하고 포용하는 방향으로 나아간다면 모든 학생이 행복하게 성장할 수 있는 이상적인 학습 환경이 될 것입니다."
  }),
  summary: '3학년 1반의 종합적인 학급 관계 분석 결과입니다. 40명 학생들의 긍정적인 관계 형성과 개선 방안을 제시합니다.',
  type: 'overview',
  session_id: 'demo-session-1'
};

const sampleStudentAnalysis1 = {
  class_id: DEMO_CLASS_ID,
  result_data: JSON.stringify({
    "analysis": "# 학습 중심 그룹 분석 (1/8)\n\n## 👥 그룹 구성원\n- **김민준** (그룹 리더)\n- **이서윤** (학습 도우미)\n- **박도현** (토론 리더)\n- **조예은** (정리 담당)\n- **신우성** (발표 담당)\n\n## 🎯 그룹 특성\n\n### 주요 강점\n- **높은 학습 동기**: 모든 구성원이 학습에 대한 강한 의욕을 보임\n- **협력적 태도**: 서로의 부족한 부분을 자연스럽게 보완\n- **리더십 공유**: 상황에 따라 리더 역할을 번갈아 담당\n\n### 관계 역학\n- **김민준**: 자연스러운 리더로 인정받으며, 다른 학생들의 의견을 잘 수렴\n- **이서윤**: 세심한 성격으로 어려워하는 친구들을 적극적으로 도움\n- **박도현**: 논리적 사고력이 뛰어나 토론 시 중요한 역할\n- **조예은**: 체계적인 성격으로 그룹 활동의 정리와 마무리 담당\n- **신우성**: 표현력이 좋아 그룹의 의견을 대표하여 발표\n\n## 📈 학습 효과\n\n### 긍정적 영향\n1. **상호 교육**: 서로 가르치고 배우는 과정에서 학습 효과 극대화\n2. **동기 부여**: 그룹 내 경쟁과 협력이 균형있게 작용\n3. **문제 해결**: 다양한 관점에서 문제를 접근하여 창의적 해결책 도출\n\n### 주의 사항\n- **과도한 완벽주의**: 때로 너무 높은 기준으로 인한 스트레스\n- **다른 그룹과의 거리**: 학습 중심적 성향으로 인한 사교적 관계 부족\n\n## 💡 교육적 활용 방안\n\n### 추천 활동\n1. **또래 교육 프로그램**: 다른 학생들을 가르치는 기회 제공\n2. **심화 학습 프로젝트**: 도전적인 과제를 통한 역량 강화\n3. **리더십 개발**: 학급 전체를 이끄는 경험 기회 확대\n\n### 개선 방향\n1. **사회적 관계 확대**: 다른 성향의 학생들과 교류 기회 증진\n2. **스트레스 관리**: 완벽주의 성향 조절을 위한 지도\n3. **다양성 수용**: 다른 학습 스타일을 가진 학생들과의 협력 경험\n\n## 🎊 종합 평가\n\n이 그룹은 학급의 학습 분위기 조성에 매우 긍정적인 역할을 하고 있습니다. 앞으로 이들의 학습 열정을 전체 학급으로 확산시키면서, 동시에 사회적 관계의 폭을 넓혀나가는 것이 중요합니다."
  }),
  summary: '학습 중심 그룹의 관계 분석입니다. 김민준, 이서윤, 박도현 등 5명의 학습 동기가 높은 학생들의 협력 관계를 분석했습니다.',
  type: 'students-1',
  session_id: 'demo-session-1'
};

const sampleStudentAnalysis2 = {
  class_id: DEMO_CLASS_ID,
  result_data: JSON.stringify({
    "analysis": "# 사교적 그룹 분석 (2/8)\n\n## 👥 그룹 구성원\n- **최하은** (그룹 중심)\n- **정우진** (분위기 메이커)\n- **강시우** (소통 리더)\n- **한별이** (공감 리더)\n- **오서현** (활동 기획자)\n\n## 🎯 그룹 특성\n\n### 주요 강점\n- **뛰어난 소통 능력**: 모든 구성원이 원활한 대화 능력을 보유\n- **포용적 분위기**: 새로운 친구들을 자연스럽게 받아들임\n- **긍정적 에너지**: 항상 밝고 활기찬 분위기 조성\n\n### 관계 역학\n- **최하은**: 자연스러운 관계 조정자 역할, 갈등 상황에서 중재 능력 탁월\n- **정우진**: 유머 감각이 뛰어나 어색한 상황을 자연스럽게 해결\n- **강시우**: 경청 능력이 좋아 친구들의 고민 상담 역할\n- **한별이**: 감정적 지지를 제공하는 그룹의 정서적 안정자\n- **오서현**: 창의적인 아이디어로 재미있는 활동을 기획\n\n## 📈 사회적 영향\n\n### 긍정적 효과\n1. **학급 분위기 개선**: 전체 학급의 화합과 활력 증진에 기여\n2. **갈등 완화**: 다른 학생들 간의 갈등 상황에서 자연스러운 중재 역할\n3. **포용 문화**: 소외될 수 있는 학생들을 적극적으로 포함시킴\n\n### 주의 사항\n- **학습 집중도**: 때로 사교 활동이 학습에 방해가 될 수 있음\n- **소음 문제**: 활발한 대화로 인한 교실 내 소음 발생\n\n## 💡 교육적 활용 방안\n\n### 추천 활동\n1. **또래 중재 프로그램**: 갈등 해결 능력을 활용한 또래 상담사 역할\n2. **학급 행사 기획**: 창의적 기획 능력을 활용한 행사 준비 위원회\n3. **신입생 도우미**: 전학생이나 새로운 친구들의 적응 도움\n\n### 개선 방향\n1. **학습 습관 개선**: 사교성과 학습의 균형 잡힌 발전\n2. **리더십 개발**: 긍정적 영향력을 더 체계적으로 발휘할 수 있는 기회 제공\n3. **책임감 강화**: 즐거운 활동과 함께 책임감도 기를 수 있는 역할 부여\n\n## 🎊 종합 평가\n\n이 그룹은 학급의 사회적 응집력과 정서적 안정감 형성에 핵심적인 역할을 하고 있습니다. 이들의 사교적 능력과 포용력을 더욱 발전시켜 학급 전체의 화합을 이끌어가는 것이 중요합니다."
  }),
  summary: '사교적 그룹의 관계 분석입니다. 최하은, 정우진, 강시우 등 5명의 소통 능력이 뛰어난 학생들의 사회적 역할을 분석했습니다.',
  type: 'students-2',
  session_id: 'demo-session-1'
};

// 생활기록부 샘플 데이터
const sampleSchoolRecord = {
  class_id: DEMO_CLASS_ID,
  result_data: JSON.stringify({
    "records": {
      "김민준": {
        "교과학습발달상황": "수학적 사고력이 뛰어나며, 문제 해결 과정에서 논리적이고 체계적인 접근을 보입니다. 특히 복잡한 응용 문제에서도 포기하지 않고 끝까지 해결하려는 의지가 강합니다.",
        "행동특성및종합의견": "학급의 자연스러운 리더로서 친구들의 의견을 수렴하고 조율하는 능력이 뛰어납니다. 또래 친구들을 도와주는 것을 좋아하며, 책임감 있게 맡은 일을 완수합니다."
      },
      "이서윤": {
        "교과학습발달상황": "국어 표현력이 우수하며, 독서를 통해 다양한 지식을 습득하고 이를 말과 글로 효과적으로 표현합니다. 창의적인 글쓰기 활동에서 독창적인 아이디어를 보여줍니다.",
        "행동특성및종합의견": "세심하고 배려심이 깊어 어려움을 겪는 친구들을 적극적으로 도와줍니다. 학급 내에서 갈등이 생겼을 때 객관적이고 공정한 관점에서 해결책을 제시합니다."
      },
      "최하은": {
        "교과학습발달상황": "예술 분야에 뛰어난 재능을 보이며, 특히 미술 시간에 창의적이고 아름다운 작품을 만들어냅니다. 색감과 구성에 대한 감각이 탁월합니다.",
        "행동특성및종합의견": "밝고 긍정적인 성격으로 학급 분위기를 활기차게 만드는 데 기여합니다. 친구들과의 관계에서 포용력이 뛰어나며, 새로운 친구들을 자연스럽게 받아들입니다."
      },
      "정우진": {
        "교과학습발달상황": "체육 활동에서 뛰어난 운동능력을 보이며, 팀 활동에서 협력과 리더십을 발휘합니다. 승부욕이 적절하여 공정한 경쟁을 추구합니다.",
        "행동특성및종합의견": "유머 감각이 뛰어나 어색하거나 긴장된 상황을 자연스럽게 해결하는 능력이 있습니다. 친구들과의 관계에서 신뢰를 바탕으로 한 깊은 우정을 유지합니다."
      },
      "박도현": {
        "교과학습발달상황": "과학적 탐구력이 뛰어나며, 실험 활동에서 적극적이고 정확한 관찰력을 보입니다. 가설 설정과 검증 과정에서 논리적 사고를 잘 활용합니다.",
        "행동특성및종합의견": "진지하고 성실한 태도로 학급 활동에 참여합니다. 토론이나 발표 활동에서 자신의 의견을 논리적으로 제시하며, 다른 사람의 의견도 경청합니다."
      }
    }
  }),
  summary: '3학년 1반 주요 학생들의 생활기록부 예시입니다.'
};

/**
 * 데모 분석 결과 삽입
 */
async function insertDemoAnalysis() {
  console.log('🎯 데모 학급에 분석 결과 삽입 중...\n');

  try {
    // 1. 기존 분석 결과 확인
    const { data: existingAnalysis } = await supabase
      .from('analysis_results')
      .select('id, type')
      .eq('class_id', DEMO_CLASS_ID);

    console.log(`📊 기존 분석 결과: ${existingAnalysis?.length || 0}개`);

    // 2. 기존 데이터 삭제 (옵션)
    if (existingAnalysis && existingAnalysis.length > 0) {
      console.log('🗑️ 기존 분석 결과 삭제 중...');
      const { error: deleteError } = await supabase
        .from('analysis_results')
        .delete()
        .eq('class_id', DEMO_CLASS_ID);

      if (deleteError) {
        console.error('❌ 기존 데이터 삭제 실패:', deleteError);
      } else {
        console.log('✅ 기존 분석 결과 삭제 완료');
      }
    }

    // 3. 새 분석 결과 삽입
    console.log('📝 새 분석 결과 삽입 중...');
    
    const analysisData = [
      sampleOverviewAnalysis,
      sampleStudentAnalysis1,
      sampleStudentAnalysis2
    ];

    const { data: insertedAnalysis, error: insertError } = await supabase
      .from('analysis_results')
      .insert(analysisData)
      .select();

    if (insertError) {
      console.error('❌ 분석 결과 삽입 실패:', insertError);
      return;
    }

    console.log(`✅ ${insertedAnalysis.length}개의 분석 결과 삽입 완료`);

    // 4. 생활기록부 처리
    const { data: existingRecords } = await supabase
      .from('school_records')
      .select('id')
      .eq('class_id', DEMO_CLASS_ID);

    console.log(`📊 기존 생활기록부: ${existingRecords?.length || 0}개`);

    // 기존 생활기록부 삭제
    if (existingRecords && existingRecords.length > 0) {
      console.log('🗑️ 기존 생활기록부 삭제 중...');
      const { error: deleteRecordError } = await supabase
        .from('school_records')
        .delete()
        .eq('class_id', DEMO_CLASS_ID);

      if (deleteRecordError) {
        console.error('❌ 기존 생활기록부 삭제 실패:', deleteRecordError);
      } else {
        console.log('✅ 기존 생활기록부 삭제 완료');
      }
    }

    // 새 생활기록부 삽입
    console.log('📝 새 생활기록부 삽입 중...');
    const { data: insertedRecord, error: recordError } = await supabase
      .from('school_records')
      .insert([sampleSchoolRecord])
      .select();

    if (recordError) {
      console.error('❌ 생활기록부 삽입 실패:', recordError);
    } else {
      console.log('✅ 생활기록부 삽입 완료');
    }

    console.log('\n🎉 데모 데이터 삽입 완료!');
    console.log('📋 삽입된 데이터:');
    console.log(`   - 종합 분석: 1개`);
    console.log(`   - 학생 그룹 분석: 2개`);
    console.log(`   - 생활기록부: 1개`);

  } catch (error) {
    console.error('❌ 전체 과정 실패:', error);
  }
}

// 스크립트 실행
insertDemoAnalysis(); 